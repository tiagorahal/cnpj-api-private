# üè¢ CNPJ API PRIVATE

API privada para **consultas completas de CNPJ**, com autentica√ß√£o JWT, limites de uso por plano, filtros avan√ßados e cruzamento inteligente de dados empresariais.

---

## üöÄ Instala√ß√£o

### Op√ß√£o 1: Com Docker (Recomendado)

#### Requisitos do Sistema

- **Docker** e **Docker Compose** instalados
- **50GB de espa√ßo em disco** (para dados completos da Receita Federal)
- **8GB+ de RAM** recomendado (m√≠nimo 4GB)
- **Conex√£o est√°vel com internet** (download de ~5GB de dados)

#### ‚öôÔ∏è Configura√ß√£o de Mem√≥ria (IMPORTANTE!)

Antes de iniciar, ajuste as configura√ß√µes de mem√≥ria no arquivo `database/scripts/import_cnpj_postgresql.py` de acordo com sua m√°quina:

```python
# Configura√ß√µes de mem√≥ria - AJUSTE CONFORME SUA M√ÅQUINA
MAX_RAM_GB = 30      # Limite de RAM (use 70% da RAM dispon√≠vel)
MAX_SWAP_GB = 5      # Limite de SWAP
CHUNK_SIZE = 100_000 # Tamanho do chunk (reduza se tiver pouca mem√≥ria)
N_WORKERS = 4        # Workers paralelos (n√∫mero de cores da CPU)
DASK_THREADS = 4     # Threads dask (igual a N_WORKERS)
```

**Recomenda√ß√µes por configura√ß√£o:**

| RAM do Sistema | MAX_RAM_GB | CHUNK_SIZE | N_WORKERS |
|---------------|------------|------------|-----------|
| 4GB           | 2          | 50_000     | 2         |
| 8GB           | 5          | 75_000     | 2         |
| 16GB          | 11         | 100_000    | 4         |
| 32GB          | 22         | 150_000    | 6         |
| 64GB+         | 45         | 200_000    | 8         |

#### Setup R√°pido (Teste)

Para testar rapidamente a API sem baixar todos os dados da Receita:

```bash
# Clone o reposit√≥rio
git clone https://github.com/seu-usuario/cnpj-api-private.git
cd cnpj-api-private

# Setup r√°pido com dados de teste
make quick-start
```

Este comando ir√°:
- ‚úÖ Configurar o banco PostgreSQL
- ‚úÖ Criar usu√°rio admin (admin@cnpj.com / admin123)
- ‚úÖ Iniciar API em http://localhost:8430/docs
- ‚úÖ Iniciar Dashboard Admin em http://localhost:8501
- ‚úÖ Iniciar Interface de Consultas em http://localhost:8502

#### Setup Completo (Produ√ß√£o)

Para ambiente de produ√ß√£o com todos os dados da Receita Federal:

```bash
# Clone o reposit√≥rio
git clone https://github.com/seu-usuario/cnpj-api-private.git
cd cnpj-api-private

# IMPORTANTE: Ajuste as configura√ß√µes de mem√≥ria antes!
# Edite: database/scripts/import_cnpj_postgresql.py

# Setup completo com download da Receita Federal
make full-setup
```

‚ö†Ô∏è **ATEN√á√ÉO**: Este processo pode demorar **4-6 horas** e ir√°:
- üì• Baixar ~5GB de dados da Receita Federal
- üíæ Importar para PostgreSQL (ocupar√° ~50GB)
- üîÑ Criar √≠ndices e otimiza√ß√µes
- ‚úÖ Configurar API e Dashboards

#### Comandos Docker √öteis

```bash
# Ver todos os comandos dispon√≠veis
make help

# Iniciar servi√ßos
make up

# Parar servi√ßos
make down

# Ver logs
make logs
make logs-api    # Apenas API
make logs-db     # Apenas banco

# Acessar shell do container
make shell      # Shell da API
make db-shell   # Shell do PostgreSQL

# Fazer backup do banco
make backup

# Restaurar backup
make restore FILE=backups/arquivo.sql

# Ver estat√≠sticas do banco
make stats

# Reset completo (CUIDADO: apaga todos os dados!)
make reset
```

---

### Op√ß√£o 2: Instala√ß√£o Manual (Sem Docker)

#### Requisitos

- **Python 3.11+**
- **PostgreSQL 15+**
- **50GB de espa√ßo em disco**
- **8GB+ de RAM**

#### Passo a Passo

1. **Clone o reposit√≥rio:**
```bash
git clone https://github.com/seu-usuario/cnpj-api-private.git
cd cnpj-api-private
```

2. **Configure o PostgreSQL:**
```bash
# Crie o banco de dados
sudo -u postgres psql
CREATE DATABASE cnpj_rede;
CREATE USER admin WITH PASSWORD 'admin123';
GRANT ALL PRIVILEGES ON DATABASE cnpj_rede TO admin;
\q

# Execute o script de inicializa√ß√£o
psql -U admin -d cnpj_rede -f init.sql
```

3. **Instale as depend√™ncias Python:**
```bash
# Crie ambiente virtual
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate  # Windows

# Instale depend√™ncias
pip install -r requirements.txt
```

4. **Configure vari√°veis de ambiente:**
```bash
# Crie arquivo .env
cat > .env << EOF
DB_USER=admin
DB_PASSWORD=admin123
DB_HOST=localhost
DB_PORT=5432
DB_NAME=cnpj_rede
SECRET_KEY=sua_chave_secreta_super_segura_aqui_32_chars_min
EOF
```

5. **Ajuste configura√ß√µes de mem√≥ria:**

Edite `database/scripts/import_cnpj_postgresql.py` conforme tabela de recomenda√ß√µes acima.

6. **Baixe e importe dados da Receita Federal:**
```bash
# Baixar dados (demora ~1 hora)
cd database/scripts
python dados_cnpj_baixa.py

# Importar para PostgreSQL (demora 3-5 horas)
python import_cnpj_postgresql.py
```

7. **Crie usu√°rio admin:**
```bash
cd ../..
python -c "
import psycopg2
import bcrypt

conn = psycopg2.connect(
    host='localhost',
    database='cnpj_rede',
    user='admin',
    password='admin123'
)
cur = conn.cursor()

# Cria schema e tabela
cur.execute('CREATE SCHEMA IF NOT EXISTS security')
cur.execute('''
    CREATE TABLE IF NOT EXISTS security.users (
        id SERIAL PRIMARY KEY,
        email TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        email_confirmed INTEGER DEFAULT 1,
        is_active INTEGER DEFAULT 2,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
''')

# Cria usu√°rio admin
password_hash = bcrypt.hashpw(b'admin123', bcrypt.gensalt()).decode('utf-8')
cur.execute('''
    INSERT INTO security.users (email, password_hash, email_confirmed, is_active)
    VALUES (%s, %s, 1, 2)
''', ('admin@cnpj.com', password_hash))

conn.commit()
print('‚úÖ Usu√°rio admin criado!')
"
```

8. **Inicie os servi√ßos:**
```bash
# Terminal 1 - API
uvicorn app.main:app --host 0.0.0.0 --port 8430 --reload

# Terminal 2 - Dashboard Admin
streamlit run app/streamlit_app.py --server.port 8501

# Terminal 3 - Interface de Consultas
streamlit run app/streamlit_front.py --server.port 8502
```

---

## üñ•Ô∏è Interfaces do Sistema

### 1. API REST (http://localhost:8430)
- **Documenta√ß√£o interativa:** http://localhost:8430/docs
- **Endpoints RESTful** para integra√ß√£o com sistemas
- **Autentica√ß√£o JWT** para seguran√ßa

### 2. Dashboard Administrativo (http://localhost:8501)
- **Gerenciamento de usu√°rios** e permiss√µes
- **Estat√≠sticas de uso** do sistema
- **Monitoramento** de requisi√ß√µes
- **Login:** admin@cnpj.com / admin123

### 3. Interface de Consultas (http://localhost:8502)
- **Interface visual** para testes e consultas
- **Exporta√ß√£o para Excel** dos resultados
- **Todos os endpoints** dispon√≠veis visualmente
- **Login:** Use suas credenciais de usu√°rio

![Interface de Consultas](docs/interface-consultas.png)

---

## üë§ Acesso ao Sistema

### Usu√°rio Admin Padr√£o

Ap√≥s o setup, um usu√°rio administrador √© criado automaticamente:
- **Email:** admin@cnpj.com
- **Senha:** admin123

‚ö†Ô∏è **IMPORTANTE:** Mude a senha padr√£o ap√≥s o primeiro acesso!

### Criar Novo Usu√°rio

```bash
curl -X POST "http://localhost:8430/auth/register" \
  -H "Content-Type: application/json" \
  -d '{"email":"seu@email.com","password":"suaSenhaForte123"}'
```

---

## üîê Autentica√ß√£o (Login)

### Via API (para integra√ß√µes)

```bash
curl -X POST "http://localhost:8430/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"seu@email.com","password":"suaSenhaForte123"}'
```

Resposta:
```json
{
  "access_token": "SEU_TOKEN_JWT_AQUI",
  "token_type": "bearer"
}
```

### Via Interface Web

1. Acesse http://localhost:8502
2. Digite email e senha
3. Clique em "Entrar"
4. Use a interface visual para consultas

---

## üö¶ Limites de Uso

| Tipo de Conta | Limite | is_active | Descri√ß√£o |
|--------------|--------|-----------|-----------|
| **Gratuita** | 10 requisi√ß√µes/dia | 0 | Consultas b√°sicas |
| **Limitada** | 3.000 requisi√ß√µes/m√™s | 1 | + Cruzamentos |
| **Ilimitada** | Sem restri√ß√µes | 2 | Acesso total |

> ‚ö†Ô∏è Rotas de cruzamento exigem conta ativa (`is_active >= 1`)

---

## üìö Endpoints da API

### Documenta√ß√£o Interativa

- **Swagger UI:** http://localhost:8430/docs
- **ReDoc:** http://localhost:8430/redoc

### Consultas B√°sicas

```bash
# 1. Buscar CNPJ espec√≠fico
curl -X GET "http://localhost:8430/api/cnpj/60409075000152" \
  -H "Authorization: Bearer SEU_TOKEN"

# 2. Listar por UF
curl -X GET "http://localhost:8430/api/cnpj/uf/SP?page=1" \
  -H "Authorization: Bearer SEU_TOKEN"

# 3. Listar por munic√≠pio
curl -X GET "http://localhost:8430/api/cnpj/municipio/SAO%20PAULO?page=1" \
  -H "Authorization: Bearer SEU_TOKEN"

# 4. Listar por CNAE principal
curl -X GET "http://localhost:8430/api/cnpj/cnae_principal/1099699?page=1" \
  -H "Authorization: Bearer SEU_TOKEN"
```

### Consultas Combinadas

```bash
# 5. UF + CNAE principal
curl -X GET "http://localhost:8430/api/cnpj/uf/SP/cnae_principal/1099699?page=1" \
  -H "Authorization: Bearer SEU_TOKEN"

# 6. Munic√≠pio + CNAE
curl -X GET "http://localhost:8430/api/cnpj/municipio/SAO%20PAULO/cnae_principal/1099699?page=1" \
  -H "Authorization: Bearer SEU_TOKEN"
```

### üîó Cruzamentos e Relacionamentos (Conta Ativa)

```bash
# 7. CNPJs com mesmo endere√ßo
curl -X GET "http://localhost:8430/api/cruzamentos/enderecos/compartilhados?endereco=RUA%20X" \
  -H "Authorization: Bearer SEU_TOKEN"

# 8. CNPJs com mesmo email
curl -X GET "http://localhost:8430/api/cruzamentos/emails/compartilhados?email=exemplo@mail.com" \
  -H "Authorization: Bearer SEU_TOKEN"

# 9. CNPJs com mesmo telefone
curl -X GET "http://localhost:8430/api/cruzamentos/telefones/compartilhados?ddd=11&telefone=12345678" \
  -H "Authorization: Bearer SEU_TOKEN"

# 10. Rede de relacionamentos
curl -X GET "http://localhost:8430/api/cruzamentos/rede/60409075000152" \
  -H "Authorization: Bearer SEU_TOKEN"

# 11. An√°lise de grupo econ√¥mico
curl -X GET "http://localhost:8430/api/cruzamentos/analise/grupo_economico/60409075000152" \
  -H "Authorization: Bearer SEU_TOKEN"
```

---

## üõ°Ô∏è Seguran√ßa

- **JWT:** Todas as rotas exigem autentica√ß√£o
- **Bcrypt:** Senhas criptografadas
- **Rate Limiting:** Controle por usu√°rio
- **Audit Log:** Registro de todas as opera√ß√µes
- **Auto-block:** Bloqueio por uso abusivo

---

## üìä Estrutura do Banco de Dados

```
cnpj_rede (PostgreSQL)
‚îú‚îÄ‚îÄ cnpj.*              # Dados principais das empresas
‚îÇ   ‚îú‚îÄ‚îÄ empresas        # Informa√ß√µes cadastrais
‚îÇ   ‚îú‚îÄ‚îÄ socios          # Quadro societ√°rio
‚îÇ   ‚îî‚îÄ‚îÄ simples         # Dados do Simples Nacional
‚îú‚îÄ‚îÄ rede.*              # Relacionamentos e v√≠nculos
‚îÇ   ‚îú‚îÄ‚îÄ enderecos       # Endere√ßos √∫nicos
‚îÇ   ‚îú‚îÄ‚îÄ emails          # Emails √∫nicos
‚îÇ   ‚îî‚îÄ‚îÄ telefones       # Telefones √∫nicos
‚îú‚îÄ‚îÄ links.*             # Cruzamentos de dados
‚îÇ   ‚îú‚îÄ‚îÄ cnpj_endereco   # V√≠nculos CNPJ-endere√ßo
‚îÇ   ‚îú‚îÄ‚îÄ cnpj_email      # V√≠nculos CNPJ-email
‚îÇ   ‚îî‚îÄ‚îÄ cnpj_telefone   # V√≠nculos CNPJ-telefone
‚îî‚îÄ‚îÄ security.*          # Usu√°rios e autentica√ß√£o
    ‚îî‚îÄ‚îÄ users           # Tabela de usu√°rios
```

---

## üîß Desenvolvimento

### Estrutura do Projeto

```
cnpj-api-private/
‚îú‚îÄ‚îÄ app/                    # C√≥digo da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ api/               # Endpoints da API
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # Autentica√ß√£o JWT
‚îÇ   ‚îú‚îÄ‚îÄ models/            # Modelos do banco
‚îÇ   ‚îú‚îÄ‚îÄ streamlit_app.py   # Dashboard admin
‚îÇ   ‚îî‚îÄ‚îÄ streamlit_front.py # Interface de consultas
‚îú‚îÄ‚îÄ database/              
‚îÇ   ‚îî‚îÄ‚îÄ scripts/           # Scripts de importa√ß√£o
‚îú‚îÄ‚îÄ docker-compose.yml     # Configura√ß√£o Docker
‚îú‚îÄ‚îÄ Dockerfile            # Build das imagens
‚îú‚îÄ‚îÄ Makefile              # Comandos √∫teis
‚îú‚îÄ‚îÄ requirements.txt      # Depend√™ncias Python
‚îî‚îÄ‚îÄ init.sql             # Schema do banco
```

### Vari√°veis de Ambiente

```env
# Banco de Dados
DB_USER=admin
DB_PASSWORD=admin123
DB_HOST=localhost  # ou 'db' para Docker
DB_PORT=5432
DB_NAME=cnpj_rede

# JWT
SECRET_KEY=sua_chave_secreta_super_segura_aqui_32_chars_min

# Configura√ß√µes de Importa√ß√£o
MAX_RAM_GB=30        # Ajuste conforme sua m√°quina
MAX_SWAP_GB=5
CHUNK_SIZE=100000
N_WORKERS=4
DASK_THREADS=4

# Docker Only
SKIP_DOWNLOAD=false  # Pula download se true
SKIP_IMPORT=false    # Pula importa√ß√£o se true
DEBUG_MODE=false     # Mant√©m container rodando se true
```

### üêõ Troubleshooting

**Erro de mem√≥ria durante importa√ß√£o:**
- Reduza `MAX_RAM_GB` e `CHUNK_SIZE` no arquivo de configura√ß√£o
- Aumente o swap do sistema se poss√≠vel

**Processo muito lento:**
- Aumente `N_WORKERS` se tiver cores de CPU dispon√≠veis
- Use SSD ao inv√©s de HDD para melhor performance

**Container n√£o inicia:**
```bash
# Verificar logs
docker compose logs -f importer

# Entrar no container para debug
docker compose run --rm importer bash
```

**PostgreSQL connection refused:**
```bash
# Verificar se PostgreSQL est√° rodando
sudo systemctl status postgresql

# Verificar configura√ß√µes em pg_hba.conf
sudo nano /etc/postgresql/15/main/pg_hba.conf
# Adicione: host all all 127.0.0.1/32 md5
```

### Contribuindo

1. Fork o projeto
2. Crie sua feature branch (`git checkout -b feature/NovaFuncionalidade`)
3. Commit suas mudan√ßas (`git commit -m 'Add: Nova funcionalidade'`)
4. Push para a branch (`git push origin feature/NovaFuncionalidade`)
5. Abra um Pull Request

---

## üìù Licen√ßa

Projeto privado. Todos os direitos reservados.

---

## üìû Suporte

- **Issues:** [Abra uma issue no GitHub](https://github.com/tiagorahal/cnpj-api-private/issues)
- **Email:** rahal.aires@gmail.com
- **API Docs:** http://localhost:8430/docs
- **Dashboard Admin:** http://localhost:8501
- **Interface Consultas:** http://localhost:8502

---
